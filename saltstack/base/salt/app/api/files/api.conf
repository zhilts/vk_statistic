upstream django-api {
    server unix:///var/run/user/family-tree-api.sock;
}

server {
    listen      80;
    listen      443 ssl;
    server_name {{ grains['host'] }}.family-tree.com {{ pillar['agent'][grains['environment']] }}.family-tree.com;
    charset     utf-8;

    # If in-secure, redirect to SSL
    if ($scheme = http) {
        return 301 https://$host$request_uri;
    }

    ## SSL Config with Strong Ciphers (https://cipherli.st)
    ssl_certificate             /etc/pki/tls/certs/user.com.crt;
    ssl_certificate_key         /etc/pki/tls/private/user.com.key;
    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers			AES128+EECDH:AES128+EDH:HIGH:!RC4:!MD5:!aNULL:!EDH;			# 41 ciphers
    #ssl_ciphers		ECDHE-RSA-AES128-SHA256:AES128-GCM-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH;	# 42 ciphers
    #ssl_ciphers		EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH;			# 16 ciphers (recommended, too strict)
    ssl_prefer_server_ciphers   on;

    # Manage SSL Session
    ssl_session_cache           shared:SSL:10m;
    ssl_session_timeout         5m;
    ssl_session_tickets         off;

    # Enable SSL Stapling
    ssl_stapling                on;
    ssl_stapling_verify         on;
    resolver                    172.31.0.2 8.8.8.8 valid=300s;
    resolver_timeout            5s;

    # Enable HSTS(HTTP Strict Transport Security) to avoid ssl stripping
    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";

    ## Avoid clickjacking attacks (disabled, managed by application [SAMEORIGIN])
    #add_header X-Frame-Options DENY;

    # Prevents the browser from doing MIME-type sniffing
    add_header X-Content-Type-Options nosniff;

    # Max Upload Size
    client_max_body_size 75M;

    # Static Content
    location /static {
        alias /home/user/concierge/concierge-assets/current/src/static/;
    }

    # Maintenance Page
    error_page 503 /maintenance.html;
    location /maintenance.html {
        allow all;
        alias /home/user/concierge/maintenance/maintenance.html;
    }

    # Application Content
    location / {
        root  /usr/share/nginx/html;

        # Maintenance Redirect
        if ( $host ~ "my.family-tree.com" ) {
          set $maint e;
        }
        if ( -f /var/run/user/maint-enabled.txt ) {
          set $maint "${maint}nabled";
        }
        if ( $maint = "enabled" ) {
          return 503;
        }

        # Django Proxy Settings
        proxy_set_header Upgrade $http_upgrade; # settings for WebSockets
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Proto $scheme;

        if ( $maint != "enabled" ) {
          proxy_pass http://django-agent;
        }
    }

    # Logging Config
    error_log  /var/log/nginx/agent/agent-error.log;
    access_log /var/log/nginx/agent/agent-access.log postdata;
}

server {
    listen      80;
    listen      443 ssl;
    server_name {{ grains['fqdn'] }} {{ pillar['agent'][grains['environment']] }}.family-tree.int;
    charset     utf-8;

    # If in-secure, redirect to SSL
    if ($scheme = http) {
        return 301 https://$host$request_uri;
    }

    ## SSL Config with Strong Ciphers (https://cipherli.st)
    ssl_certificate             /etc/pki/tls/certs/user.int.crt;
    ssl_certificate_key         /etc/pki/tls/private/user.int.key;
    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers			AES128+EECDH:AES128+EDH:HIGH:!RC4:!MD5:!aNULL:!EDH;			# 41 ciphers
    #ssl_ciphers		ECDHE-RSA-AES128-SHA256:AES128-GCM-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH;	# 42 ciphers
    #ssl_ciphers		EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH;			# 16 ciphers (recommended, too strict)
    ssl_prefer_server_ciphers   on;

    # Manage SSL Session
    ssl_session_cache           shared:SSL:10m;
    ssl_session_timeout         5m;
    ssl_session_tickets         off;

    # Enable SSL Stapling
    ssl_stapling                on;
    ssl_stapling_verify         on;
    resolver                    172.31.0.2 8.8.8.8 valid=300s;
    resolver_timeout            5s;

    # Enable HSTS(HTTP Strict Transport Security) to avoid ssl stripping
    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";

    ## Avoid clickjacking attacks (disabled, managed by application [SAMEORIGIN])
    #add_header X-Frame-Options DENY;

    # Prevents the browser from doing MIME-type sniffing
    add_header X-Content-Type-Options nosniff;

    # Max Upload Size
    client_max_body_size 75M;

    # Static Content
    location /static {
        alias /home/user/concierge/concierge-assets/current/src/static/;
    }

    # Application Content
    location / {
        root  /usr/share/nginx/html;

        # Django Proxy Settings
        proxy_set_header Upgrade $http_upgrade; # settings for WebSockets
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://django-agent;
    }

    # Logging Config
    error_log  /var/log/nginx/agent/agent-error.log;
    access_log /var/log/nginx/agent/agent-access.log postdata;
}
